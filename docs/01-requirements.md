# 01. 要件仕様書（完全詳細版）

---

## 1. 機能仕様

### 1.1 カウンセリングフォーム入力

- 入力項目一覧（全て日本語ラベル・英語フィールド名併記）

  - 年齢 `current_age`（int, 1〜120, 必須）
  - 性別 `gender`（enum: male/female/other, 必須）
  - 喫煙開始年齢 `smoking_start_age`（int, 1〜120, 必須）
  - 1 日あたり喫煙本数 `daily_cigarettes`（int, 0〜100, 必須）
  - タバコ種類 `cigarette_type`（enum: 通常タバコ/メンソールタバコ/電子タバコ, 必須）
  - ブランド名 `cigarette_brand`（str, 最大 32 文字, 任意）
  - 禁煙試行回数 `quit_attempts`（int, 0〜99, 必須）
  - 現在の健康問題 `current_health_issues`（array[str], 最大 8 件, 任意）
  - 運動頻度 `exercise_frequency`（int, 0〜7, 必須）
  - 飲酒頻度 `alcohol_consumption`（int, 0〜7, 必須）
  - 睡眠時間 `sleep_hours`（float, 0〜24, 必須）
  - 過去医師助言 `previous_medical_advice`（str, 最大 128 文字, 任意）

- バリデーション：全必須項目が OK 時のみ「次へ」ボタン有効化

- 画面遷移：入力 → 確認 → 顔写真アップロード → 診断実行 → 結果表示

---

### 1.2 顔写真アップロード

- JPEG/PNG/WebP, 最大 10MB
- プレビュー表示
- クライアント側・サーバ側でファイルサイズ/形式/破損/寸法チェック

---

### 1.3 回答内容・画像の確認と診断実行

- 入力内容・画像プレビュー表示
- 「診断実行」ボタンは全データ有効時のみ有効化
- 診断 API 呼び出し中はローディング表示

---

### 1.4 診断 API

- POST `/api/diagnose`
- リクエスト:
  ```json
  {
    "session_id": "string (UUID)",
    "questionnaire": { ...問診データJSON... }
  }
  ```
- レスポンス:
  ```json
  {
    "success": true,
    "data": {
      "current_skin_status": "string",
      "predicted_impact": "string",
      "smoking_habits_results": { ...詳細分析... },
      "current_effects_results": { ...画像分析... }
    }
  }
  ```
- バリデーション: セッション ID・問診データ必須。不正時はエラー返却

---

### 1.5 画像生成 API

- POST `/api/generate-image`
- リクエスト:
  ```json
  {
    "session_id": "string (UUID)",
    "diagnosis_result": { ...診断結果JSON... }
  }
  ```
- レスポンス:
  ```json
  {
    "success": true,
    "data": {
      "future_image_url": "string (署名付きURL)",
      "future_image_results": { ...画像生成分析... }
    }
  }
  ```
- バリデーション: セッション ID・診断結果必須。不正時はエラー返却

---

### 1.6 データ削除 API

- DELETE `/api/session/{session_id}`
- 概要: 指定セッション ID のメモリ上データ・画像ファイルを即時削除
- レスポンス:
  ```json
  {
  	"success": true
  }
  ```
- バリデーション: セッション ID 必須。不正時はエラー返却

---

### 1.7 結果表示

- 診断結果テキスト＋画像（現在/20 年後）統合表示
- エラー時は画面上部に赤色で文言表示

---

## 2. データ仕様

### 2.1 問診・診断・セッションデータ管理

- 問診データ・診断結果・セッション情報は全てサーバーメモリ内で一時管理
- セッション ID は UUID 等で生成し、各セッションに紐付けて管理
- セッション情報はメモリ上で保持し、セッション終了または有効期限（例: 30 分）経過時に自動削除
- 利用者データは原則保持せず、永続化は最小限
- サーバーメモリ使用量が閾値（例: 512MB）を超えた場合は古いセッションから順次削除

### 2.2 画像ファイル一時保存・自動削除仕様

- 画像ファイルは Cloud Storage に一時保存
- 保存パス: `uploads/{sessionId}/original.{ext}`
- MIME: JPEG/PNG/WebP、最大 10MB
- 保存後、診断・画像生成処理完了時に自動削除
- 保存期間は最長 1 時間、もしくは処理完了時点で即時削除
- ファイル名は UUID ＋タイムスタンプで一意化

### 2.3 データ自動削除ポリシー

- セッション有効期限（例: 30 分）経過時にメモリ上のデータ自動削除
- 画像ファイルは処理完了後即時削除、または保存期間超過時に自動削除
- 利用者データは原則保持せず、プライバシー保護を徹底

### 2.4 プライバシー保護強化策

- 利用者識別情報（IP, UserAgent 等）は記録しない
- 画像・診断データは処理完了後即時削除
- Cloud Storage は署名付き URL のみ発行、公開 URL は利用不可
- サーバーメモリ上のデータは暗号化管理（必要に応じて）
- ログ出力は個人情報を含まない形式で実施

---

## 3. エラー処理・バリデーション

- 全入力項目ごとに型・値範囲・必須/任意を明記
- 画像: サイズ/形式/破損/寸法
- API: 必須フィールド存在・型チェック
- 項目下に赤色で表示（例：「必須項目です」「形式が不正です」）
- API エラーは画面上部に表示
- 例外ケース一覧（ファイルサイズ超過・形式不正・認証失敗・セッション不整合等）

---

## 4. 非機能要件

### 4.1 パフォーマンス

- 画像アップロード・診断・生成処理は 10 秒以内
- 同時リクエスト 100 件まで安定稼働
- サーバーメモリ使用量は 512MB 以内に制限、閾値超過時は古いセッションから自動削除

### 4.2 セキュリティ・プライバシー

- API 認証（Bearer トークン/JWT）
- Cloud Storage は署名付き URL のみ発行、公開 URL は利用不可
- 画像ファイル・診断データは処理完了後即時削除
- HTTPS 通信必須
- 個人情報は一切保持しない設計
- 脆弱性検査（OWASP Top10）

### 4.3 セッション管理・有効期限

- セッション有効期限は 30 分（設定可能）
- 有効期限経過時にメモリ上データ・画像ファイルを自動削除
- セッション終了時にも即時削除

### 4.4 スケーラビリティ

- メモリベース管理のため、同時セッション数はメモリ制約内で動的に管理
- サーバーメモリ閾値超過時は古いセッションから順次削除
- Cloud Run インスタンスの水平スケールに対応

### 4.5 可用性・信頼性

- Cloud Run SLA: 99.9%
- 障害時自動リカバリ・ロールバック手順明記

### 4.6 ユーザビリティ

- 直感的 UI（3 ステップ以内で診断完了）
- エラー率 5%未満
- 操作説明・ヘルプ表示

---

## 5. インフラ・運用要件

- Cloud Run 設定値: CPU 1vCPU, メモリ 512MB, 最大同時リクエスト 100, タイムアウト 30 秒, ヘルスチェック `/health`
- ログ出力仕様: レベル INFO/ERROR, フォーマット JSON, 出力先 Cloud Logging
- モニタリング・アラート: Cloud Monitoring で API レスポンス時間・エラー率監視、10 秒超・エラー率 5%以上でアラート通知
- デプロイ・リリース手順: Dockerfile ベースで Cloud Build→Cloud Run へ自動デプロイ、ロールバック手順明記、バージョン管理（タグ付け）

---

## 6. テスト要件

- 単体テスト: API 正常系/異常系（ファイル未指定・認証なし・バリデーション不備）、各入力項目のバリデーションテスト
- 結合テスト: 画像アップロード → 診断 → 画像生成 → 結果表示の一連フロー、セッション管理・進捗通知
- 負荷テスト: 10MB 画像同時 100 件アップロード、診断 API 同時 100 件リクエスト
- セキュリティテスト: 認証/認可/権限チェック、脆弱性検査（SQLi, XSS, CSRF 等）

---

## 7. 参考：システムアーキテクチャとの整合性

- 処理フロー・API・データ構造は [`docs/02-system-architecture.md`](docs/02-system-architecture.md:1) に完全準拠
- Mermaid シーケンス図参照

---

## 8. 仕様変更・拡張時の注意

- 本仕様書に記載の型・値範囲・エラー文言・運用手順を必ず遵守
- 変更時は必ず docs/02-system-architecture.md との整合性を確認

---
